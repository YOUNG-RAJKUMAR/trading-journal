<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledger // Pro + Media</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #000000; --surface: #0a0a0a; --border: #222222;
            --primary: #ffffff; --negative: #ff4444; --positive: #44ff88; 
            --text: #cccccc; --text-light: #ffffff;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        /* HEADER & NAV */
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .header-title { font-weight: 300; font-size: 1.5rem; color: var(--text-light); letter-spacing: 2px; text-transform: uppercase; }
        .action-btns { display: flex; gap: 10px; }
        .btn-small { font-size: 0.7rem; padding: 8px 15px; border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; text-transform: uppercase; }
        .tab-nav { display: flex; gap: 20px; margin-bottom: 30px; }
        .tab-btn { background: transparent; border: none; color: var(--text); padding-bottom: 10px; cursor: pointer; font-size: 0.85rem; text-transform: uppercase; opacity: 0.5; }
        .tab-btn.active { opacity: 1; border-bottom: 2px solid var(--primary); color: var(--text-light); }

        /* FORMS */
        .card { background: var(--surface); border: 1px solid var(--border); padding: 25px; margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        input, select, textarea, button { background: var(--bg); border: 1px solid var(--border); color: var(--text-light); padding: 12px; font-size: 0.85rem; font-family: inherit; }
        textarea { grid-column: span 2; height: 80px; resize: none; }
        .file-input-wrapper { grid-column: span 1; position: relative; }
        .save-btn { background: var(--text-light); color: var(--bg); border: none; font-weight: 600; cursor: pointer; }

        /* TABLE & MEDIA */
        table { width: 100%; border-collapse: collapse; }
        th { color: #888; padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.7rem; text-transform: uppercase; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.85rem; vertical-align: top; }
        .trade-note { font-size: 0.75rem; color: #777; margin-top: 5px; max-width: 250px; }
        .img-preview { width: 60px; height: 40px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .img-preview:hover { transform: scale(2); z-index: 100; position: relative; }

        /* CALENDAR & STATS */
        .calendar-layout { display: grid; grid-template-columns: 1fr 320px; gap: 30px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); }
        .cal-day { background: var(--surface); min-height: 90px; padding: 10px; }
        .cal-day.profit { border-left: 2px solid var(--positive); }
        .cal-day.loss { border-left: 2px solid var(--negative); }
        .side-card { background: var(--surface); border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; }
        .side-label { font-size: 0.65rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .side-val { font-size: 1.6rem; color: #fff; margin: 5px 0; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="app-container" id="main-content">
    <header class="header-top">
        <h1 class="header-title">Ledger // Media</h1>
        <div class="action-btns">
            <button class="btn-small" onclick="ui.undoLast()">Undo</button>
            <button class="btn-small" onclick="ui.resetAll()">Reset</button>
            <button class="btn-small" style="background:#fff; color:#000" onclick="ui.exportPDF()">Export PDF</button>
        </div>
    </header>

    <nav class="tab-nav">
        <button class="tab-btn active" onclick="ui.switchTab('journal')">Journal</button>
        <button class="tab-btn" onclick="ui.switchTab('calendar')">Performance</button>
        <button class="tab-btn" onclick="ui.switchTab('analytics')">Analytics</button>
    </nav>

    <div id="tab-journal" class="tab-content active">
        <div class="card">
            <div class="form-grid">
                <input type="text" id="t-symbol" placeholder="Symbol (e.g. XAUUSD)">
                <select id="t-asset"><option value="100000">Forex</option><option value="1000">Gold</option><option value="10">Indices</option></select>
                <input type="number" id="t-lots" placeholder="Lots" step="0.01">
                <select id="t-side"><option value="BUY">Long</option><option value="SELL">Short</option></select>
                <input type="number" id="t-entry" placeholder="Entry Price">
                <input type="number" id="t-exit" placeholder="Exit Price">
                <input type="date" id="t-date">
                <div class="file-input-wrapper">
                    <input type="file" id="t-img" accept="image/*" style="font-size: 0.6rem;">
                </div>
                <textarea id="t-notes" placeholder="Trade Setup Notes... (e.g. Rejection at H4 Supply)"></textarea>
                <button onclick="ui.handleNewTrade()" class="save-btn" id="saveBtn">Record Trade</button>
            </div>
        </div>
        <div class="card" style="overflow-x:auto;">
            <table>
                <thead><tr><th>Date</th><th>Asset</th><th>Result</th><th>P/L ($)</th><th>Notes / Screenshot</th></tr></thead>
                <tbody id="tradeBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-calendar" class="tab-content">
        <div class="calendar-layout">
            <div>
                <div style="margin-bottom:20px; display:flex; gap:10px;">
                    <select id="cal-month" onchange="ui.renderCalendar()"></select>
                    <select id="cal-year" onchange="ui.renderCalendar()"></select>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            <div class="side-stats">
                <div class="side-card"><span class="side-label">Today</span><div id="side-today" class="side-val">$0</div><div id="wr-today" style="font-size:0.8rem">WR: 0%</div></div>
                <div class="side-card"><span class="side-label">This Month</span><div id="side-month" class="side-val">$0</div><div id="wr-month" style="font-size:0.8rem">WR: 0%</div></div>
            </div>
        </div>
    </div>

    <div id="tab-analytics" class="tab-content">
        <div class="card">
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px;">
                <div><span class="side-label">Profit Factor</span><div id="s-pf" class="side-val">0.00</div></div>
                <div><span class="side-label">Gross Profit</span><div id="s-gp" class="side-val" style="color:var(--positive)">$0</div></div>
                <div><span class="side-label">Gross Loss</span><div id="s-gl" class="side-val" style="color:var(--negative)">$0</div></div>
            </div>
        </div>
        <div class="card"><h3>Equity Curve</h3><canvas id="equityChart" height="100"></canvas></div>
    </div>
</div>

<script>
const JournalStore = {
    key: 'ledger_media_v10',
    fetch: () => JSON.parse(localStorage.getItem(JournalStore.key)) || [],
    save: (d) => localStorage.setItem(JournalStore.key, JSON.stringify(d))
};

const ui = {
    charts: {},
    init() {
        document.getElementById('t-date').valueAsDate = new Date();
        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById('cal-month').innerHTML = months.map((m,i)=>`<option value="${i}" ${i===new Date().getMonth()?'selected':''}>${m}</option>`).join('');
        document.getElementById('cal-year').innerHTML = [2025, 2026].map(y=>`<option value="${y}" ${y===new Date().getFullYear()?'selected':''}>${y}</option>`).join('');
        this.renderAll();
    },
    switchTab(id) {
        document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${id}`).classList.add('active');
        event.currentTarget.classList.add('active');
        this.renderAll();
    },
    async handleNewTrade() {
        const btn = document.getElementById('saveBtn');
        btn.innerText = "Processing...";
        
        const file = document.getElementById('t-img').files[0];
        let imgBase64 = "";
        
        if (file) {
            imgBase64 = await this.compressImage(file);
        }

        const entry = parseFloat(document.getElementById('t-entry').value);
        const exit = parseFloat(document.getElementById('t-exit').value);
        const lots = parseFloat(document.getElementById('t-lots').value);
        const mult = parseFloat(document.getElementById('t-asset').value);
        
        const trade = {
            id: Date.now(),
            symbol: document.getElementById('t-symbol').value.toUpperCase() || 'TRD',
            side: document.getElementById('t-side').value,
            profit: (exit - entry) * lots * mult * (document.getElementById('t-side').value === 'BUY' ? 1 : -1),
            date: document.getElementById('t-date').value,
            notes: document.getElementById('t-notes').value,
            img: imgBase64
        };

        const data = JournalStore.fetch();
        data.push(trade);
        JournalStore.save(data);
        
        // Reset form
        document.getElementById('t-notes').value = "";
        document.getElementById('t-img').value = "";
        btn.innerText = "Record Trade";
        this.renderAll();
    },
    compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxW = 400; // Small size to save storage
                    const scale = maxW / img.width;
                    canvas.width = maxW;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // 70% quality
                };
            };
        });
    },
    renderAll() {
        const trades = JournalStore.fetch();
        const body = document.getElementById('tradeBody'); body.innerHTML = '';
        let cumulative = [0], gP = 0, gL = 0;

        trades.forEach(t => {
            if(t.profit > 0) gP += t.profit; else gL += Math.abs(t.profit);
            cumulative.push(cumulative[cumulative.length-1] + t.profit);
            
            body.innerHTML += `
                <tr>
                    <td>${t.date}</td>
                    <td><b>${t.symbol}</b><br><small style="color:#555">${t.side}</small></td>
                    <td><span style="color:${t.profit>=0?'var(--positive)':'var(--negative)'}">${t.profit>=0?'WIN':'LOSS'}</span></td>
                    <td style="color:${t.profit>=0?'var(--positive)':'var(--negative)'}">$${t.profit.toFixed(2)}</td>
                    <td>
                        ${t.img ? `<img src="${t.img}" class="img-preview" onclick="window.open(this.src)">` : ''}
                        <div class="trade-note">${t.notes || ''}</div>
                    </td>
                </tr>`;
        });

        document.getElementById('s-pf').innerText = gL > 0 ? (gP/gL).toFixed(2) : gP.toFixed(2);
        document.getElementById('s-gp').innerText = `$${gP.toFixed(0)}`;
        document.getElementById('s-gl').innerText = `-$${gL.toFixed(0)}`;

        this.updateCharts(cumulative, ['0', ...trades.map(t=>t.date)]);
        this.renderCalendar();
        this.updateSideStats(trades);
    },
    updateSideStats(trades) {
        const todayStr = new Date().toISOString().split('T')[0];
        const tTrades = trades.filter(t => t.date === todayStr);
        const mTrades = trades.filter(t => new Date(t.date).getMonth() === new Date().getMonth());

        const calc = (list) => {
            const pnl = list.reduce((s, t) => s + t.profit, 0);
            const w = list.filter(t => t.profit > 0).length;
            const wr = list.length > 0 ? Math.round((w/list.length)*100) : 0;
            return { pnl, wr };
        };

        const tData = calc(tTrades), mData = calc(mTrades);
        document.getElementById('side-today').innerText = `$${tData.pnl.toFixed(0)}`;
        document.getElementById('side-today').style.color = tData.pnl >=0 ? 'var(--positive)' : 'var(--negative)';
        document.getElementById('wr-today').innerText = `WR: ${tData.wr}%`;
        
        document.getElementById('side-month').innerText = `$${mData.pnl.toFixed(0)}`;
        document.getElementById('side-month').style.color = mData.pnl >=0 ? 'var(--positive)' : 'var(--negative)';
        document.getElementById('wr-month').innerText = `WR: ${mData.wr}%`;
    },
    renderCalendar() {
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        const m = parseInt(document.getElementById('cal-month').value), y = parseInt(document.getElementById('cal-year').value);
        const days = new Date(y, m + 1, 0).getDate();
        const trades = JournalStore.fetch();
        for (let i = 1; i <= days; i++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dayPL = trades.filter(t => t.date === dStr).reduce((s, t) => s + t.profit, 0);
            grid.innerHTML += `<div class="cal-day ${dayPL!==0?(dayPL>0?'profit':'loss'):''}"><b>${i}</b>${dayPL!==0?`<div style="font-size:0.7rem; color:${dayPL>0?'var(--positive)':'var(--negative)'}">$${dayPL.toFixed(0)}</div>`:''}</div>`;
        }
    },
    updateCharts(data, labels) {
        if(this.charts.equity) this.charts.equity.destroy();
        this.charts.equity = new Chart(document.getElementById('equityChart'), {
            type: 'line', data: { labels, datasets: [{ data, borderColor: '#fff', fill: true, backgroundColor: 'rgba(255,255,255,0.05)', tension: 0.2 }] },
            options: { scales: { x: { display: false }, y: { grid: { color: '#111' } } }, plugins: { legend: { display: false } } }
        });
    },
    undoLast() { const d = JournalStore.fetch(); d.pop(); JournalStore.save(d); this.renderAll(); },
    resetAll() { if(confirm("Clear all data?")) { JournalStore.save([]); this.renderAll(); } },
    exportPDF() { html2pdf().from(document.getElementById('main-content')).save('Trading_Report.pdf'); }
};
window.onload = () => ui.init();
</script>
</body>
</html>